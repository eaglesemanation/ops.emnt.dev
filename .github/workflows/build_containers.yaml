name: "Build containers and push to GHCR"

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io

jobs:
  get_changed_dockerfiles:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      IMAGE_LIST: ${{ steps.set_images.outputs.IMAGE_LIST }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get list of changed container files
        id: set_images
        run: |
          IMAGE_LIST="$(git diff --name-only ${{ github.event.before }} HEAD -- 'containers/*.Dockerfile' | jq -R -c --slurp 'split("\n") | map(select(length > 0))')"
          echo "List of changed docker files:" >> "${GITHUB_STEP_SUMMARY}"
          echo "${IMAGE_LIST}" | jq -r '.[]' >> "${GITHUB_STEP_SUMMARY}"
          echo "IMAGE_LIST=${IMAGE_LIST}" >> "${GITHUB_OUTPUT}"

  build_changed_images:
    name: "Build image: ${{ matrix.image }}"
    runs-on: ubuntu-latest
    needs: get_changed_dockerfiles
    strategy:
      matrix:
        image: ${{ fromJson( needs.get_changed_dockerfiles.outputs.IMAGE_LIST ) }}

    steps:
      - name: Print image name from matrix
        run: |
          echo "${{ matrix.image }}"
