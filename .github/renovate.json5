{
    $schema: "https://docs.renovatebot.com/renovate-schema.json",
    extends: ["config:recommended"],
    timezone: "America/Toronto",
    schedule: ["after 19:00 on friday"],
    prHourlyLimit: 5,
    rangeStrategy: "bump",
    flux: {
        managerFilePatterns: ["/k8s/.+\\.k8s\\.yaml/"],
    },
    dockerfile: {
        managerFilePatterns: ["/containers/.+\\.Dockerfile/"],
    },
    kubernetes: {
        managerFilePatterns: ["/k8s/.+\\.k8s\\.yaml/"],
    },
    customDatasources: {
        digitalOceanAlpineImg: {
            defaultRegistryUrlTemplate: "https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/cloud",
            format: "html",
            transformTemplates: [
                // Extract image details from links
                "(\
                    $releases := releases.version[$ != \"../\"].(\
                        $baseAndExt := $match($, /^([^\.]+\d+\.\d+\.\d+[^\.]+)(\..*)$/);\
                        {\
                            \"baseName\": $baseAndExt.groups[0],\
                            \"extensions\": $baseAndExt.groups[1]\
                        }\
                    ){`baseName`: [extensions]};\
                    $releases := $each($releases, function($v, $k) {(\
                        $parts := $split($k, \"-\");\
                        $revision := $match($k, /-r(\d+)/).groups[0];\
                        $versionParts := $split($parts[1], \".\");\
                        {\
                            \"basename\": $k,\
                            \"extensions\": $v,\
                            \"cloud\": $substringBefore($parts[0], \"_\"),\
                            \"version\": {\
                                \"major\": $number($versionParts[0]),\
                                \"minor\": $number($versionParts[1]),\
                                \"patch\": $number($versionParts[2]),\
                                \"revision\": $number($revision)\
                            },\
                            \"arch\": $parts[2],\
                            \"fw\": $parts[3],\
                            \"init\": $parts[4],\
                            \"baremetal\": $parts[5] = \"metal\"\
                        }\
                    )})\
                )",
                // Filter out version that is compatible with DigitalOcean
                "[cloud=\"generic\" and arch=\"x86_64\" and fw=\"bios\" and init=\"cloudinit\" and baremetal=false]\
                    ^(>version.major, >version.minor, >version.patch, >version.revision)[0]",
                // Format for Renovate to consume
                "{\
                    \"homepage\": \"https://alpinelinux.org\",\
                    \"sourceUrl\": \"https://gitlab.alpinelinux.org/alpine/aports\",\
                    \"changelogUrl\": \"https://alpinelinux.org/posts\",\
                    \"release\": [$.{\"version\": $.basename}]\
                }",
            ],
        },
    },
    customManagers: [
        {
            customType: "regex",
            description: "Update container images in CRDs",
            datasourceTemplate: "docker",
            managerFilePatterns: ["/k8s/.+\\.k8s\\.yaml$/"],
            matchStrings: [
                "apiVersion:\\s+minio.min.io\\/v\\d+.*\\nkind:\\s+Tenant\\s*\\n(?:.*\\n)*?\\s*image:\\s*(?<depName>[\\w\\.\\/\\-]+):(?<currentValue>[\\w+\\.\\-]*)",
            ],
        },
        {
            customType: "regex",
            description: "Process custom dependencies",
            managerFilePatterns: ["/k8s/.+\\.k8s\\.yaml$/"],
            matchStrings: [
                'renovate: datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)( versioning=(?<versioning>\\S+))?\n.*?"(?<currentValue>.*)"\n',
                "renovate: datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)( versioning=(?<versioning>\\S+))? version=(?<currentValue>.*)\n",
            ],
            datasourceTemplate: "{{#if datasource}}{{{datasource}}}{{else}}github-releases{{/if}}",
            versioningTemplate: "{{#if versioning}}{{{versioning}}}{{else}}semver{{/if}}",
        },
    ],
    packageRules: [
        {
            matchPackageNames: [
                "docker.io/linuxserver/jellyfin",
                "docker.io/linuxserver/transmission",
            ],
            allowedVersions: "<1000",
        },
    ],
}
