# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prometheus
  namespace: prometheus
spec:
  interval: 30m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 51.0.2
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
      interval: 30m
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  values:
    defaultRules:
      rules:
        # Not used with Cilium
        kubeProxy: false
    kubeControllerManager:
      service:
        selector:
          k8s-app: kube-controller-manager
    kubeScheduler:
      service:
        selector:
          k8s-app: kube-scheduler
    kubeEtcd:
      endpoints:
        - ${K8S_CONTROLLER_1_ADDR}
    grafana:
      grafana.ini:
        server:
          root_url: https://grafana.emnt.dev/
        auth.basic:
          enabled: "false"
        auth.generic_oauth:
          enabled: "true"
          auto_login: "true"
          name: authentik
          client_id: jQ9qSWQebjh5yzXdo1LwjtMDYCrtE63MtIM4wsD7
          scopes: openid profile email
          auth_url: https://authentik.emnt.dev/application/o/authorize/
          token_url: https://authentik.emnt.dev/application/o/token/
          api_url: https://authentik.emnt.dev/application/o/userinfo/
          role_attribute_path: "contains(groups[*], 'authentik Admins') && 'Admin' || 'Viewer'"
        auth.anonymous:
          enabled: "true"
          org_name: No Org
          org_role: Viewer
          hide_version: "true"
        auth:
          signout_redirect_url: https://authentik.emnt.dev/application/o/grafana/end-session/
          disable_signout_menu: "true"
      envFromSecrets:
        - name: grafana-oidc
      admin:
        existingSecret: grafana-creds
        userKey: username
        passwordKey: password
      ingress:
        enabled: true
        ingressClassName: ingress-internal-traefik
        hosts:
          - grafana.emnt.dev
    prometheus:
      ingress:
        enabled: false # Using traefik IngressRoute
    alertmanager:
      alertmanagerSpec:
        alertmanagerConfiguration:
          name: alertmanager-global-config
