apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: postgres
  namespace: authentik
spec:
  teamId: "emnt"
  numberOfInstances: 1
  enableMasterLoadBalancer: false
  volume:
    storageClass: freenas-api-iscsi-csi
    size: 1Gi
  users:
    authentik_user: 
      - superuser
      - createdb
  databases:
    authentik: authentik_user
  postgresql:
    version: "15"
    parameters:
      password_encryption: scram-sha-256
  sidecars:
    - name: exporter
      image: docker.io/bitnami/postgres-exporter
      ports:
        - name: exporter
          containerPort: 9187
          protocol: TCP
      resources:
        requests:
          cpu: 100m
          memory: 200M
        limits:
          memory: 256M
      env:
        - name: "DATA_SOURCE_URI"
          value: "postgres/database?sslmode=disable"
        - name: "DATA_SOURCE_USER"
          valueFrom:
            secretKeyRef:
              name: postgres.postgres.credentials.postgresql.acid.zalan.do
              key: username
        - name: "DATA_SOURCE_PASS"
          valueFrom:
            secretKeyRef:
              name: postgres.postgres.credentials.postgresql.acid.zalan.do
              key: password
---
apiVersion: v1
kind: Service
metadata:
  name: pg-exporter
  namespace: authentik
  labels:
    app.kubernetes.io/name: pg-exporter
    app.kubernetes.io/instance: authentik
spec:
  ports:
    - name: exporter
      port: 9187
      targetPort: exporter
  selector:
    application: spilo
    team: emnt
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/monitoring.coreos.com/servicemonitor_v1.json
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: pg-exporter
  namespace: authentik
  labels:
    release: prometheus
spec:
  endpoints:
    - targetPort: 9187
  jobLabel: app.kubernetes.io/instance
  namespaceSelector:
    matchNames:
      - authentik
  selector:
    matchLabels:
      app.kubernetes.io/name: pg-exporter
