apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vanilla
  namespace: minecraft
spec:
  interval: 30m
  chart:
    spec:
      chart: minecraft
      version: 4.6.0
      sourceRef:
        kind: HelmRepository
        name: itzg-minecraft
        namespace: flux-system
      interval: 30m
  values:
    resources:
      limits:
        memory: 4Gi
        cpu: 2000m
    extraVolumes:
      - volumes:
          - name: vanilla-config
            configMap:
              name: vanilla-config
              items:
                - key: vane-admin.yaml
                  path: plugins/vane-admin/config.yml
    initContainers:
      - name: copy-config
        image: busybox
        command: ["sh", "-c", "cp -r /src/* /dest"]
        volumeMounts:
          - name: vanilla-config
            mountPath: "/src"
          - name: datadir
            mountPath: "/dest"
    minecraftServer:
      eula: "TRUE"
      type: "PAPER"
      maxPlayers: 10
      motd: "Vanilla survival"
      spigetResources:
        - 1997 # ProtocolLib
        - 34315 # Vault
    extraEnv:
      MODRINTH_PROJECTS: "vane"
      MODRINTH_ALLOWED_VERSION_TYPE: "release"
    persistence:
      storageClass: freenas-api-iscsi-csi
      dataDir:
        enabled: true
